---
title: "Differential expression analyses"
output: html_document
date: "2024-03-26"
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
# Read functions & packages
source("scripts/functions/themes_palettes.R")
source("scripts/functions/functions_utility.R")
source("scripts/functions/functions_analyses.R")
source("scripts/functions/functions_visualization.R")

# Read data
data <- import_df("data/processed/final_data/final_olink_data.csv")  
metadata <- import_df("data/processed/final_data/combined_metadata.csv")  
meta_medeca <- import_df("data/processed/final_data/medeca_metadata.csv")  
meta_allvos <- import_df("data/processed/final_data/allvos_metadata.csv")  
```


# MEDECA

```{r}
# Prepare data
limma_meta_medeca <- 
  meta_medeca |> 
  select(Sample, Cancer, Age, Sex) 
  
limma_data_medeca <- 
  data |> 
  filter(Sample %in% limma_meta_medeca$Sample) |> 
  pivot_wider(names_from = Assay, 
              values_from = NPX) 

# Run differential expression analyses
medeca_de <-
  do_limma(data_wide = limma_data_medeca, 
           metadata = limma_meta_medeca,
           variable = "Cancer", 
           case = "Yes",
           correct = T) 
 

volcano_medeca <- plot_volcano(medeca_de) + ggtitle("MEDECA")
```

# ALLVOS

```{r}
# Prepare data
limma_meta_allvos <- 
  meta_allvos |>
  select(Sample, Cancer, Age, Sex) 
  
limma_data_allvos <- 
  data |> 
  filter(Sample %in% limma_meta_allvos$Sample) |> 
  pivot_wider(names_from = Assay, 
              values_from = NPX) 

 # Run differential expression analyses
allvos_de <-
  do_limma(data_wide = limma_data_allvos, 
           metadata = limma_meta_allvos,
           variable = "Cancer", 
           case = "Yes",
           correct = T) 
 

volcano_allvos <- plot_volcano(allvos_de) + ggtitle("ALLVOS")
```


# Volcano plot

```{r}
medeca_de |> 
  left_join(allvos_de |> 
              select(Assay, sig_ALLVOS = sig)) |> 
  mutate(Significant = case_when(sig == "significant up" & sig_ALLVOS == "significant up" ~ "Upregulated in both",
                                 sig == "significant down" & sig_ALLVOS == "significant down" ~ "Downregulated in both",
                                   TRUE ~ "Not significant or discordant")) |> 
    ggplot(aes(x = logFC, y = -log10(adj.P.Val), color = Significant, label = Assay)) +
    geom_point(size = 1, alpha = 0.4, show.legend = F) + 
    geom_text_repel( size = 2, show.legend = F) +
    geom_hline(yintercept = -log10(0.05), linetype = 'dashed', color = "darkgrey") +
    geom_vline(xintercept = -0.5, linetype = 'dashed', color = "darkgrey") +
    geom_vline(xintercept = 0.5, linetype = 'dashed', color = "darkgrey") +
    scale_color_manual(values = unname(pal_de)) +
    theme_hpa() +   
    theme(axis.text = element_text(size = 8),
          legend.position = "top") 

ggsave(savepath("MEDECA_ALLVOS_volcano.pdf"), h = 4, w = 4)
```

# Top proteins

```{r}
# Select top replicated proteins
proteins <- 
  medeca_de |> 
  left_join(allvos_de |> 
              select(Assay, 
                     sig_ALLVOS = sig, 
                     FC_ALLVOS = logFC,
                     pval_ALLVOS = adj.P.Val)) |> 
  mutate(Significant = case_when(sig == "significant up" & sig_ALLVOS == "significant up" ~ "Upregulated in both",
                                 sig == "significant down" & sig_ALLVOS == "significant down" ~ "Downregulated in both",
                                   TRUE ~ "Not significant or discordant")) |> 
  filter(Significant == "Upregulated in both") |> 
  select(Assay, 
         FC_MEDECA = logFC, 
         FC_ALLVOS,
         pval_MEDECA = adj.P.Val,
         pval_ALLVOS) 

# Beeswarms
library("ggrain")
top_proteins <- 
  proteins |> 
  head(7) |> 
  pull(Assay)

data |> 
  filter(Sample %in% c(meta_medeca$Sample, meta_allvos$Sample)) |> 
  filter(Assay %in% top_proteins) |> 
  left_join(combined_meta, by = "Sample") |> 
  mutate(Cohort = factor(Cohort, levels = c("MEDECA", "ALLVOS")),
         Assay = factor(Assay, levels = top_proteins)) |> 
  ggplot(aes(Cancer, NPX, fill = Cancer, color = Cancer)) +
  geom_rain(alpha = 0.5) +
  facet_grid(Assay~Cohort, scales = "free") +
  scale_color_manual(values = pal_cancer) +
  scale_fill_manual(values = pal_cancer) +
  theme_hpa()

ggsave(savepath("top_proteins.pdf"), h = 12, w = 5)


# Heatmap
annotation_cols <- 
  proteins |> 
  column_to_rownames("Assay") 

combined_meta <- 
  meta_medeca |> 
  select(Sample, Cancer) |> 
  mutate(Cohort = "MEDECA") |> 
  bind_rows(meta_allvos |> 
  select(Sample, Cancer) |> 
  mutate(Cohort = "ALLVOS")) 

annotation_rows <- 
  combined_meta |> 
  column_to_rownames("Sample") 

reduced_data <- 
  data |> 
  filter(Assay %in% proteins$Assay,
         Sample %in% c(meta_allvos$Sample, meta_medeca$Sample)) 

reduced_data |> 
  filter(Sample %in% meta_all$Sample) |> 
  pivot_wider(names_from = Assay, values_from = NPX) |> 
  column_to_rownames("Sample") |> 
  scale() |> 
  pheatmap(show_rownames = F,
           clustering_method = "ward.D2",
           annotation_row = annotation_rows,
           annotation_col = annotation_cols)

pca_reduced <- 
  do_pca(data = reduced_data,
       meta = combined_meta,
       variable = "Cohort",
       wide = F,
       plots = T)

pca_reduced$pca_plot
```

# Functional characterization

```{r}

proteins_func <- 
  medeca_de |> 
  select(Assay, logFC, adj.P.Val) |> 
  mutate(Cohort = "MEDECA") |> 
  bind_rows(allvos_de |> 
              select(Assay, logFC, adj.P.Val) |> 
              mutate(Cohort = "ALLVOS")) |> 
  filter(Assay %in% proteins$Assay)


#hpa <- 
library(paletteer)
hpa <- import_df("data/hpa/proteinatlas.tsv")
pancancer_markers <- import_df("data/41467_2023_39765_MOESM7_ESM.xlsx")


|>

    View()

secreted <- 
  hpa |> 
  distinct(Secretome.location) |> 
  filter(grepl("Secreted", Secretome.location)) |> 
  pull()

part_2 <- 
  hpa |> 
  filter(Gene %in% proteins$Assay) |> 
  select(Gene,
         RNA.tissue.specificity, 
         Secretome.location,
         Secretome.function,
         Biological.process,
         Molecular.function,
         Disease.involvement) |> 
  mutate(Pan_cancer_maker = ifelse(Gene %in% pancancer_markers$Protein, "Yes", "No"),
         Secreted = ifelse(Secretome.location %in% secreted, "Yes", "No"),
         Tissue_enriched = ifelse(RNA.tissue.specificity == "Tissue enriched", "Yes", "No"),
         Cancer_related = case_when(grepl("Cancer",Disease.involvement) ~ "Yes",
                                    grepl("Proto-oncogene",Disease.involvement) ~ "Yes",
                                    T ~ "No"),
         Gene = factor(Gene, levels = rev(proteins$Assay))) |> 
  select(Gene, Secreted, Tissue_enriched, Cancer_related, Pan_cancer_maker) |> 
  pivot_longer(cols = -Gene, names_to = "Type", values_to = "Value") |> 
  ggplot(aes(Type, Gene, fill = Value)) +
  geom_tile(color = "white") +
  coord_fixed() +
  scale_fill_manual(values = c("grey90", "grey30")) +
  xlab("") +
  theme_hpa(angled = T, axis_y = F)


pal_red <- rev(colorRampPalette(brewer.pal(6, "Reds"))(10))
part_1 <- 
  proteins_func |> 
  mutate(Assay= factor(Assay, levels = rev(proteins$Assay)),
         Cohort = factor(Cohort, levels = c("MEDECA", "ALLVOS"))) |>
  ggplot(aes(Cohort, Assay, color = logFC, size = -log10(adj.P.Val))) +
  geom_point() +
  scale_color_paletteer_c(palette = "ggthemes::Red") +
  theme_hpa(angled = T) +
  theme(axis.ticks.y = element_blank(),
        legend.position = "left") +
  ylab("") +
  xlab("")

part_1 + part_2
ggsave(savepath("proteins_functional_characterization.pdf"), h = 12, w = 6)
```


