---
title: "Cohort_overview"
output: html_document
date: "2024-03-26"
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
# Read functions & packages
source("scripts/themes_palettes.R")
source("scripts/functions_utility.R")
source("scripts/functions_analyses.R")
source("scripts/functions_visualization.R")

# Read data
data <- 
  import_df("data/processed/olink_data/olink_data_qc.csv") |> 
  rename(Sample = SampleID) |> 
  mutate(Sample = as.character(Sample))

metadata <- import_df("data/Exports from R after processing updated data files/all_data.xlsx")

metadata <- 
  metadata |> 
  select(!starts_with("Olink")) |>
  rename(Sample = Patient_number) |> 
  filter(Sample %in% data$Sample) |> 
  mutate(ID = as.numeric(Sample), 
         Cohort = ifelse(ID > 1000, "ALLVOS", "MEDECA")) |> 
  select(-ID)

metadata_medeca <- import_df("data/2024-04-04 pat 1-728.xlsx")
metadata_allvos <- import_df("data/Cohortdata proteomics 240429 till fredrika.xlsx")
```

# Metadata pre-processing

## MEDECA

```{r}
keep_columns <- c("Patient number", "Sex 1 male", "Age", "CUP", "Ongoing cancer known prior to DC", 
                  "Loss to follow up","Other disease than cancer", "No disease", "Autoimmune1",
                  "Inflammatory", "Infectious", "thromboembolism", "Other disease", "Metastases", 
                  "Carcinom", "Germinal cell tumors", "SCC", "Urothelial", "Neuroendocrine tumors",
                  "Adenocarcinoma", "HCC", "Kidney", "Adrenal", "Prostate", "Lung", "Breast", "Thyroid",
                  "Gynecologic","Ovarian or tubar", "Colorectal", "Urine bladder", "Merkel cell carcinoma",
                  "Small cell parotid", "Pancreas or gall bladder or bile duct", "Ventricle", 
                  "Other adenocarcinoma", "Other carcinoma such as mesothelioma", "Sarkom", "Lymfom",
                  "Melanom", "Myelom", "MDS MPN", "Other cancer")

meta_medeca <- 
  metadata_medeca |>
  select(keep_columns) |> 
  rename(Sample = `Patient number`) |> 
  mutate(`Loss to follow up` = ifelse(is.na(`Loss to follow up`), 0, `Loss to follow up`)) |>
  filter(Sample %in% data$Sample,
         `Ongoing cancer known prior to DC` == 0,
         `Loss to follow up` != 1) |> 
  mutate(Sex = ifelse(`Sex 1 male` == 1, "Male", "Female")) |> 
  select(-`Ongoing cancer known prior to DC`, -`Loss to follow up`, - `Sex 1 male`) |> 
  relocate(Sex, .after = "Age") |> 
  mutate(Disease_type = case_when(`Other disease than cancer` == 0 & `No disease` == 0 ~ "Cancer",
                             `Other disease than cancer` == 0 & `No disease` == 1 ~ "Healthy",
                             `Other disease than cancer` == 1 & `No disease` == 0 ~ "Other diseases",
                             T ~ NA),
         Other_disease = case_when(Autoimmune1 == 1 ~ "Autoimmune",
                                   Inflammatory == 1 ~ "Inflammatory", 
                                   Infectious == 1 ~ "Infectious", 
                                   thromboembolism == 1 ~ "Other", 
                                   `Other disease` == 1 ~ "Other"),
         Cancer = ifelse(Disease_type == "Cancer", "Yes", "No"),
         Cancer = ifelse(Sample == 494, "No", Cancer),
         Disease_type = ifelse(Sample == 494, "Other diseases", Disease_type)) |> 
  select(-Autoimmune1, -Inflammatory, -Infectious, -thromboembolism) |> 
  relocate(Disease_type, Other_disease, .after = Sex) |> 
  mutate(Sample = as.character(Sample))
```

## ALLVOS 

```{r}
meta_allvos <- 
  metadata_allvos |>
  mutate(`Lost to follow up` = ifelse(is.na(`Lost to follow up`), 0, `Lost to follow up`)) |> 
  filter(`Ongoing cancer` != 1,
         `Lost to follow up` != 1,
         StudyID %in% data$Sample) |> 
  select(Sample = StudyID, Age, Sex, Cancer) |> 
  mutate(Cancer = ifelse(Cancer == 1, "Yes", "No"),
         Sample = as.character(Sample)) 
```

## Combine

```{r}
meta_combined <- 
  meta_medeca |> 
  select(Sample, Age, Sex, Cancer) |> 
  mutate(Cohort = "MEDECA") |> 
  bind_rows(meta_allvos |> 
              select(Sample, Age, Sex, Cancer) |> 
              mutate(Cohort = "ALLVOS")) |> 
  mutate(Sample = as.character(Sample))
```


# Overview of the cohort


## Sample distribution MEDECA/ALLVOS

```{r}
# Visualize the number of cases in both cohorts
p_right <- 
  meta_combined  |>
  group_by(Cancer) |>
  count(Cohort) |>
  ungroup() |> 
  group_by(Cohort) |> 
  mutate(cum_n = cumsum(n)) |> 
  mutate(Cancer = factor(Cancer, levels = c("Yes", "No")),
         Cohort = factor(Cohort, levels = rev(c("MEDECA", "ALLVOS")))) |>
  ggplot(aes(Cohort, n, fill = Cancer)) +
  geom_col(width = 0.5) +
  scale_fill_manual(values = pal_cancer) + 
  geom_text(aes(label = n, y = cum_n - 20), vjust = -0.5, fontface = "bold", color = "white") +
  theme_hpa() +
#  ggtitle("Cancer detection") +
  coord_flip() +
  theme(axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line.y = element_blank())

p_left <- 
  meta_combined  |>
  group_by(Cohort) |>
  count(Sex) |>
  ungroup() |> 
  group_by(Cohort) |> 
  mutate(cum_n = cumsum(n)) |> 
  mutate(Cohort = factor(Cohort, levels = rev(c("MEDECA", "ALLVOS"))),
         Sex = factor(Sex, levels = c("Male", "Female"))) |>
  ggplot(aes(Cohort, n, fill = Sex)) + 
  geom_col(width = 0.5) +
  scale_fill_manual(values = pal_sex) + 
  geom_text(aes(label = n, y = cum_n - 20), vjust = -0.5, fontface = "bold", color = "white") +
  theme_hpa(axis_y = F) + 
  scale_y_reverse() +
  coord_flip() +
  theme(legend.position = "left")
  
p_age <- 
  meta_combined |>
  ggplot(aes(y = Cohort, x = Age, fill = Cancer)) +
  geom_density_ridges(quantile_lines = TRUE, quantiles = 2, alpha = 0.6, show.legend = F, scale = 1) +
  scale_fill_manual(values = pal_cancer) +
  theme_hpa(axis_y = F) 
  
p_left + p_right + p_age
ggsave(savepath("cancer_detected_cohort.pdf"), h = 4, w = 12)

```

## Controls MEDECA

```{r}
meta_medeca |>  
  mutate(Other_disease = ifelse(is.na(Other_disease), Disease_type, Other_disease),
         Other_disease = ifelse(Other_disease == "Other diseases", NA, Other_disease)) |>
  group_by(Disease_type) |>
  filter(Disease_type != "Cancer") |> 
  count(Other_disease) |> 
  mutate(total = sum(n)) |> 
  mutate(Group = factor(Other_disease, levels = c("Cancer", "Healthy", "Autoimmune", "Infectious", "Inflammatory", "Other"))) |> 
  ggplot(aes(Disease_type, n, fill = Other_disease)) +
  geom_col() +
  geom_text(aes(label = total, y = total + 5)) + 
  scale_fill_manual(values = pal_group) +
  theme_hpa() +
  ggtitle("MEDECA controls") +
  xlab("")
  
ggsave(savepath("MEDECA_controls.png"), h = 5, w = 5)

meta_medeca |>  
  mutate(Other_disease = ifelse(is.na(Other_disease), Disease_type, Other_disease),
         Other_disease = ifelse(Other_disease == "Other diseases", NA, Other_disease)) |>
  filter(Disease_type != "Cancer") |> 
  group_by(Other_disease) |> 
  count() |> 
  filter(!is.na(Other_disease)) |>
  mutate(Other_disease = factor(Other_disease, levels = c("Cancer", "Healthy", "Autoimmune", "Infectious", "Inflammatory", "Other"))) |> 
  ggplot(aes(Other_disease, n, fill = Other_disease)) +
  geom_col() +
  geom_text(aes(label = n, y = n + 5)) + 
  scale_fill_manual(values = pal_group) +
  theme_hpa(angled = T) +
  xlab("")
  
ggsave(savepath("MEDECA_controls.pdf"), h = 5, w = 4)
```

## PCA MEDECA

```{r}
# Subset MEDECA data
data_medeca <- 
  data |> 
  filter(Sample %in% meta_medeca$Sample)

# Run PCA
pca_medeca <- 
  do_pca(data = data_medeca, 
         meta = meta_medeca,
         variable = "Disease_type", 
         wide = F,
         impute = T,
         plots = T)

pca_medeca$pca_plot 

# Manuscript figure
pca_medeca$pca_res %>%
  left_join(meta_medeca, by = "Sample") %>%
  ggplot(aes(PC1, PC2)) +
  geom_point(aes(color = Disease_type), alpha = 0.7, size = 2, show.legend = F) +
  scale_color_manual(values = pal_group_3) +
  labs(color = NULL) +
  theme_hpa() +

meta_medeca |>
  filter(Sample %in% data$Sample) |> 
  mutate(Other_disease = ifelse(is.na(Other_disease), Disease_type, Other_disease),
         Other_disease = ifelse(Other_disease == "Other diseases", NA, Other_disease)) |>
  mutate(Disease_type = ifelse(Sample == "138", "Other diseases", Disease_type)) |> 
  #filter(Disease_type != "Cancer") |> 
  group_by(Disease_type,Other_disease) |> 
  count() |> 
  filter(!is.na(Other_disease)) |>
  mutate(Other_disease = factor(Other_disease, levels = rev(c("Cancer", "Healthy", "Autoimmune", "Infectious", "Inflammatory", "Other")))) |> 
  ggplot(aes(Other_disease, n, fill = Disease_type)) +
  geom_col() +
  geom_text(aes(label = n, y = n + 5)) + 
  scale_fill_manual(values = pal_group_3) +
  coord_flip() +
  theme_hpa(angled = T) +
  xlab("") +
  ylab("Number of samples")
  
ggsave(savepath("MEDECA_controls.pdf"), h = 4.5, w = 10)
```


# Differential expression

### MEDECA

```{r}
# Prepare data
limma_meta_medeca <- 
  meta_medeca |> 
  select(Sample, Cancer, Age, Sex) 
  
limma_data_medeca <- 
  data |> 
  filter(Sample %in% limma_meta_medeca$Sample) |> 
  pivot_wider(names_from = Assay, 
              values_from = NPX) 

# Run differential expression analyses
medeca_de <-
  do_limma(data_wide = limma_data_medeca, 
           metadata = limma_meta_medeca,
           variable = "Cancer", 
           case = "Yes",
           correct = T) 
 

volcano_medeca <- plot_volcano(medeca_de) + ggtitle("MEDECA")
```

### ALLVOS

```{r}
# Prepare data
limma_meta_allvos <- 
  meta_allvos |>
  select(Sample, Cancer, Age, Sex) 
  
limma_data_allvos <- 
  data |> 
  filter(Sample %in% limma_meta_allvos$Sample) |> 
  pivot_wider(names_from = Assay, 
              values_from = NPX) 

 # Run differential expression analyses
allvos_de <-
  do_limma(data_wide = limma_data_allvos, 
           metadata = limma_meta_allvos,
           variable = "Cancer", 
           case = "Yes",
           correct = T) 
 

volcano_allvos <- plot_volcano(allvos_de) + ggtitle("ALLVOS")
```


### Volcano plot

```{r}
medeca_de |> 
  left_join(allvos_de |> 
              select(Assay, sig_ALLVOS = sig)) |> 
  mutate(Significant = case_when(sig == "significant up" & sig_ALLVOS == "significant up" ~ "Upregulated in both",
                                 sig == "significant down" & sig_ALLVOS == "significant down" ~ "Downregulated in both",
                                   TRUE ~ "Not significant or discordant")) |> 
    ggplot(aes(x = logFC, y = -log10(adj.P.Val), color = Significant, label = Assay)) +
    geom_point(size = 1, alpha = 0.4, show.legend = F) + 
    geom_text_repel( size = 2, show.legend = F) +
    geom_hline(yintercept = -log10(0.05), linetype = 'dashed', color = "darkgrey") +
    geom_vline(xintercept = -0.5, linetype = 'dashed', color = "darkgrey") +
    geom_vline(xintercept = 0.5, linetype = 'dashed', color = "darkgrey") +
    scale_color_manual(values = unname(pal_de)) +
    theme_hpa() +   
    theme(axis.text = element_text(size = 8),
          legend.position = "top") 

ggsave(savepath("MEDECA_ALLVOS_volcano.pdf"), h = 4, w = 4)
```

### Top proteins

```{r}
# Select top replicated proteins
proteins <- 
  medeca_de |> 
  left_join(allvos_de |> 
              select(Assay, 
                     sig_ALLVOS = sig, 
                     FC_ALLVOS = logFC,
                     pval_ALLVOS = adj.P.Val)) |> 
  mutate(Significant = case_when(sig == "significant up" & sig_ALLVOS == "significant up" ~ "Upregulated in both",
                                 sig == "significant down" & sig_ALLVOS == "significant down" ~ "Downregulated in both",
                                   TRUE ~ "Not significant or discordant")) |> 
  filter(Significant == "Upregulated in both") |> 
  select(Assay, 
         FC_MEDECA = logFC, 
         FC_ALLVOS,
         pval_MEDECA = adj.P.Val,
         pval_ALLVOS) 

# Beeswarms
library("ggrain")
top_proteins <- 
  proteins |> 
  head(7) |> 
  pull(Assay)

data |> 
  filter(Sample %in% c(meta_medeca$Sample, meta_allvos$Sample)) |> 
  filter(Assay %in% top_proteins) |> 
  left_join(combined_meta, by = "Sample") |> 
  mutate(Cohort = factor(Cohort, levels = c("MEDECA", "ALLVOS")),
         Assay = factor(Assay, levels = top_proteins)) |> 
  ggplot(aes(Cancer, NPX, fill = Cancer, color = Cancer)) +
  geom_rain(alpha = 0.5) +
  facet_grid(Assay~Cohort, scales = "free") +
  scale_color_manual(values = pal_cancer) +
  scale_fill_manual(values = pal_cancer) +
  theme_hpa()

ggsave(savepath("top_proteins.pdf"), h = 12, w = 5)


# Heatmap
annotation_cols <- 
  proteins |> 
  column_to_rownames("Assay") 

combined_meta <- 
  meta_medeca |> 
  select(Sample, Cancer) |> 
  mutate(Cohort = "MEDECA") |> 
  bind_rows(meta_allvos |> 
  select(Sample, Cancer) |> 
  mutate(Cohort = "ALLVOS")) 

annotation_rows <- 
  combined_meta |> 
  column_to_rownames("Sample") 

reduced_data <- 
  data |> 
  filter(Assay %in% proteins$Assay,
         Sample %in% c(meta_allvos$Sample, meta_medeca$Sample)) 

reduced_data |> 
  filter(Sample %in% meta_all$Sample) |> 
  pivot_wider(names_from = Assay, values_from = NPX) |> 
  column_to_rownames("Sample") |> 
  scale() |> 
  pheatmap(show_rownames = F,
           clustering_method = "ward.D2",
           annotation_row = annotation_rows,
           annotation_col = annotation_cols)

pca_reduced <- 
  do_pca(data = reduced_data,
       meta = combined_meta,
       variable = "Cohort",
       wide = F,
       plots = T)

pca_reduced$pca_plot
```

## Functional characterization

```{r}

proteins_func <- 
  medeca_de |> 
  select(Assay, logFC, adj.P.Val) |> 
  mutate(Cohort = "MEDECA") |> 
  bind_rows(allvos_de |> 
              select(Assay, logFC, adj.P.Val) |> 
              mutate(Cohort = "ALLVOS")) |> 
  filter(Assay %in% proteins$Assay)


#hpa <- 
library(paletteer)
hpa <- import_df("data/hpa/proteinatlas.tsv")
pancancer_markers <- import_df("data/41467_2023_39765_MOESM7_ESM.xlsx")


|>

    View()

secreted <- 
  hpa |> 
  distinct(Secretome.location) |> 
  filter(grepl("Secreted", Secretome.location)) |> 
  pull()

part_2 <- 
  hpa |> 
  filter(Gene %in% proteins$Assay) |> 
  select(Gene,
         RNA.tissue.specificity, 
         Secretome.location,
         Secretome.function,
         Biological.process,
         Molecular.function,
         Disease.involvement) |> 
  mutate(Pan_cancer_maker = ifelse(Gene %in% pancancer_markers$Protein, "Yes", "No"),
         Secreted = ifelse(Secretome.location %in% secreted, "Yes", "No"),
         Tissue_enriched = ifelse(RNA.tissue.specificity == "Tissue enriched", "Yes", "No"),
         Cancer_related = case_when(grepl("Cancer",Disease.involvement) ~ "Yes",
                                    grepl("Proto-oncogene",Disease.involvement) ~ "Yes",
                                    T ~ "No"),
         Gene = factor(Gene, levels = rev(proteins$Assay))) |> 
  select(Gene, Secreted, Tissue_enriched, Cancer_related, Pan_cancer_maker) |> 
  pivot_longer(cols = -Gene, names_to = "Type", values_to = "Value") |> 
  ggplot(aes(Type, Gene, fill = Value)) +
  geom_tile(color = "white") +
  coord_fixed() +
  scale_fill_manual(values = c("grey90", "grey30")) +
  xlab("") +
  theme_hpa(angled = T, axis_y = F)


pal_red <- rev(colorRampPalette(brewer.pal(6, "Reds"))(10))
part_1 <- 
  proteins_func |> 
  mutate(Assay= factor(Assay, levels = rev(proteins$Assay)),
         Cohort = factor(Cohort, levels = c("MEDECA", "ALLVOS"))) |>
  ggplot(aes(Cohort, Assay, color = logFC, size = -log10(adj.P.Val))) +
  geom_point() +
  scale_color_paletteer_c(palette = "ggthemes::Red") +
  theme_hpa(angled = T) +
  theme(axis.ticks.y = element_blank(),
        legend.position = "left") +
  ylab("") +
  xlab("")

part_1 + part_2
ggsave(savepath("proteins_functional_characterization.pdf"), h = 12, w = 6)
```


# Machine learning 

## MEDECA


```{r}
# Prepare ML data
ml_data <- 
  data |> 
  filter(Sample %in% meta_medeca$Sample) |> 
  select(Sample, Assay, NPX) |> 
  pivot_wider(names_from = Assay,
              values_from = NPX) |> 
  left_join(meta_medeca |> 
              select(Sample, Cancer), by = "Sample") 

# Split data 
set.seed(213)
medeca_split <-
  ml_data |> 
  initial_split(prop = 0.7, strata = Cancer)

medeca_train <- training(medeca_split)
medeca_test <- testing(medeca_split)


ml_medeca <- 
  do_lasso(variable = "Cancer",
           case = "Yes", 
           split_train = medeca_train, 
           split_test = medeca_test) 

saveRDS(ml_medeca, savepath_data("ML", "ml_medeca.rds"))

ml_medeca$important_proteins |> View()


prob_medeca <- 
  ml_medeca$predictions |> 
  rename(Probability_case = .pred_Case) |> 
  ggplot(aes(Class, Probability_case, color = Class, fill = Class)) +
  geom_violin(alpha = 0.3,
              show.legend = F) +
  geom_quasirandom(show.legend = F) +
  geom_hline(yintercept = 0.5, 
             linetype = "dashed", 
             color = "grey") +
  stat_summary(fun = "mean",
               geom = "crossbar", 
               width = 0.3,
               colour = "grey20",
               show.legend = F) +
  scale_fill_manual(values = unname(pal_cancer)) +
  scale_color_manual(values = unname(pal_cancer)) +      
  scale_y_continuous(breaks = c(0, 0.5, 1)) +
  xlab("") +
  theme_hpa()

ml_medeca$important_proteins |> 
  head(50) |> 
  mutate(Pan_cancer_marker = ifelse(term %in% pancancer_markers$Protein, "Yes", "No")) |>
  ggplot(aes(fct_reorder(term, abs(estimate)), abs(estimate), color = Pan_cancer_marker)) +
  geom_segment(aes(x = fct_reorder(term, abs(estimate)), 
                   xend = fct_reorder(term, abs(estimate)), 
                   y = 0, 
                   yend = abs(estimate))) +
  geom_point() + 
  coord_flip() +
  theme_hpa(angled = T) +
  xlab("") +
  ylab("Model estimate") +
  scale_color_manual(values = c("grey90", "grey30")) +
  theme(axis.text.y = element_text(size = 8),
        axis.ticks.y = element_blank(),
        legend.position = "top")

ggsave(savepath("top_ml_markers.pdf"), h = 8, w = 2.5)
 

plot_ml <- 
  ml_medeca$important_proteins |> 
  head(5)

data |> 
  filter(Sample %in% c(meta_medeca$Sample, meta_allvos$Sample),
         Assay %in% plot_ml$term) |> 
  left_join(meta_combined, by = "Sample") |> 
  filter(Cohort == "MEDECA") |> 
  ggplot(aes(Cancer, NPX, fill = Cancer, color = Cancer)) +
  geom_rain(alpha = 0.5) +
  facet_grid(Assay~Cohort, scales = "free") +
  scale_color_manual(values = pal_cancer) +
  scale_fill_manual(values = pal_cancer) +
  theme_hpa()

ggsave(savepath("top_proteins_ml.pdf"), h = 10, w = 3.5)


```


## Apply to ALLVOS

```{r}
# Prepare ALLVOS data
ml_data_allvos <- 
  data |> 
  filter(Sample %in% meta_allvos$Sample) |> 
  select(Sample, Assay, NPX) |> 
  pivot_wider(names_from = Assay,
              values_from = NPX) |> 
  left_join(meta_allvos |> 
              select(Sample, Cancer), by = "Sample") |> 
  mutate(Class = case_when(Cancer == "Yes" ~ "Case",
                           Cancer!= "Yes" ~ "Control")) |> 
  mutate(Class = factor(Class)) |> 
  select(-Cancer)

allvos_fit <- predict(ml_medeca$final_fit|> extract_workflow(), 
                      ml_data_allvos, 
                      type = "prob")

allvos_dat <- 
  allvos_fit  |> 
  mutate(Pred = ifelse(.pred_Case > 0.5, "Case", "Control"),
         Cancer = ml_data_allvos$Class) 



prob_allvos <- 
  allvos_fit |> 
  rename(Probability_case = .pred_Case) |> 
  mutate(Class = ml_data_allvos$Class) |>
  ggplot(aes(Class, Probability_case, color = Class, fill = Class)) +
  geom_violin(alpha = 0.3) +
  geom_quasirandom() +
  geom_hline(yintercept = 0.5, 
             linetype = "dashed", 
             color = "grey") +
  stat_summary(fun = "mean",
               geom = "crossbar", 
               width = 0.3,
               colour = "grey20",
               show.legend = F) +
  scale_fill_manual(values = unname(pal_cancer)) +
  scale_color_manual(values = unname(pal_cancer)) +
  scale_y_continuous(breaks = c(0, 0.5, 1)) +
  xlab("") +
  theme_hpa(axis_y = F)
  
prob_medeca + prob_allvos
ggsave(savepath("probabilities_MEDECA_ALLVOS.pdf"), h = 4, w = 5)  

filter(Cancer == Pred)

# This will automatically `bake()` the recipe on `testing`,
allvos_fit <- fit(ml_medeca$final_workflow, ml_data_allvos)




# ROC curves
auc_allvos <- 
  allvos_dat |> 
  roc_auc(truth = Cancer, .pred_Case)

auc_medeca <- 
  ml_medeca$performance 

 tiles <-
  tibble(specificity = c(0.2,0.2),
         sensitivity = c(0.3,0.1),
         Cohort = c("Discovery", "Replication"),
         AUC = c(round(auc_medeca$.estimate,2),
                 round(auc_allvos$.estimate,2)))
 
 
ml_medeca$roc_curve |> 
  mutate(Cohort = "Discovery") |> 
  bind_rows(allvos_dat |> 
  roc_curve(truth = Cancer, .pred_Case) |> 
  mutate(Cohort = "Replication")) |> 
   ggplot(aes(
    x = 1 - specificity,
    y = sensitivity,
    group = Cohort
  )) +
  geom_path(aes(color = Cohort), size = 1) +
  geom_segment(aes(
    x = 0,
    y = 0,
    xend = 1,
    yend = 1
  ),
  colour = 'grey',
  linetype = 'dotdash') +
  geom_tile(
    width = 0.2, 
    height = 0.2,
    data = tiles,
    aes(fill = Cohort),
    #alpha = 0.7,
    show.legend = F
  ) +
  geom_text(
    data = tiles,
    aes(label = AUC),
    size = 3,
    color = "white",
    show.legend = F
  ) +
  geom_text(
    label = "AUC",
    x = 0.8,
    y = 0.5,
    size = 3,
    inherit.aes = F
  ) +  # Fixed the warning
  scale_color_manual(values = c("grey40", "grey70")) +
  scale_fill_manual(values = c("grey40", "grey70")) +
  scale_x_continuous(breaks = c(0, 1)) +
  scale_y_continuous(breaks = c(0, 1)) +
  theme_hpa() +
  coord_fixed() +
  theme(legend.position = "top")

ggsave(savepath("ROC_MEDECA_ALLVOS.pdf"), h = 4, w = 5)  

##########

allvos_fit_2 <- last_fit(ml_medeca$final_glmnet, ml_data_allvos)
allvos_fit_2 <- predict(ml_medeca$final_workflow |> extract_workflow(), ml_data_allvos, type = "prob")

# ROC curve
medeca_predictions <- 
  allvos_fit |> 
  collect_predictions() 

auc <- 
  medeca_predictions |> 
  roc_auc(Disease, .pred_0_Control) 

roc_medeca <- 
  medeca_predictions |> 
  roc_curve(Disease, .pred_0_Control) |> 
  autoplot() +
  geom_text(aes(label = paste0("AUC = ", round(auc$.estimate, 3)), x = 0.75, y = 0.25), inherit.aes = F) +
  theme_hpa() +
  ggtitle("ROC curve - MEDECA")

#ggsave(savepath("ROC_MEDECA.png"), h = 5, w = 5)

# Confusion matrix
cm <- 
  final_glmnet_fit %>% 
  collect_predictions() %>%
  conf_mat(truth = Disease, estimate = .pred_class) 

cm_medeca <- 
  cm |> 
  autoplot(type = "heatmap") +
  theme_hpa()

#ggsave(savepath("cm_MEDECA.png"), h = 5, w = 5)

roc_medeca + cm_medeca
ggsave(savepath("roc_cm_medeca.png"), h = 5, w = 10)


# Probabilities
medeca_predictions |> 
  ggplot(aes(.pred_Cancer, fill = Disease)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c("Cancer" = "#E16C54", "Control" = "#A0CBC7")) + 
  theme_hpa() +
  xlab("Probability cancer") +
  ggtitle("Probabilities - MEDECA") +

medeca_predictions |> 
  ggplot(aes(Disease, .pred_Cancer, color = Disease)) +
  geom_quasirandom(alpha = 0.7) +
  geom_violin(fill = NA) + 
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  scale_color_manual(values = c("Cancer" = "#E16C54", "Control" = "#A0CBC7")) + 
  theme_hpa() +
  ylab("Probability cancer") +
  ggtitle("Probabilities - MEDECA")

ggsave(savepath("prob_medeca.png"), h = 5, w = 10)

```

## Multiclass

```{r}
# Prepare ML data
multiclass_data <- 
  data |> 
  filter(Sample %in% meta_medeca$Sample) |> 
  pivot_wider(names_from = Assay,
              values_from = NPX) |> 
  left_join(meta_medeca |> 
              select(Sample, Disease_type), by = "Sample") 
  

# Split data 
set.seed(213)
multiclass_split <-
  multiclass_data |> 
  initial_split(prop = 0.7, strata = Disease_type)

multiclass_train <- training(multiclass_split)
multiclass_test <- testing(multiclass_split)


# Run ML function
medeca_multiclass <- 
  do_lasso_multiclass(variable = "Disease_type",
                    multiclass_train, 
                    multiclass_test) 

medeca_multiclass

#################
multiclass_recipe <- 
  recipe(Disease ~ ., data = multiclass_train) |> 
  update_role(Sample, new_role = "id") |> 
  step_normalize(all_numeric()) |> 
  step_nzv(all_numeric()) |> 
  step_corr(all_numeric()) |> 
  step_impute_knn(all_numeric()) 

# Generate resamples
set.seed(213)
multiclass_rs <- vfold_cv(multiclass_train, v = 10, strata = Disease)

# Define evaluation metrics for all workflows
eval_metrics <- metric_set(roc_auc, accuracy, sensitivity, specificity)

# Define control grid
set.seed(213)
ctrl <- control_grid(verbose = TRUE, 
                     allow_par = TRUE,
                     save_pred = TRUE, 
                     parallel_over = "everything") 


# Tidymodels lasso multiclassification recipe
multiclass_lasso_specs <-
  multinom_reg() |>
  set_mode("classification") |>
  set_engine("glmnet") |>
  set_args(penalty = tune(),
           mixture = 1)

# Set up lasso workflow
multiclass_wflow <-
  workflow() |> 
  add_recipe(multiclass_recipe) |> 
  add_model(multiclass_lasso_specs) 

# Define hyperparameter tuning grid
set.seed(213)
multiclass_grid <-
  multiclass_wflow |>
  extract_parameter_set_dials() |>
  grid_latin_hypercube(size = 30)

# Hyperparameter tuning
set.seed(213)
multiclass_res <-
  multiclass_wflow |>
  tune_grid(
    resamples = multiclass_rs,
    grid = multiclass_grid,
    control = ctrl,
    metrics = eval_metrics)

saveRDS(multiclass_res, "data/processed/ML_res/lasso_results_multiclass_20240506.rds")

# Explore results and select the best performing hyperparameter combination
autoplot(multiclass_res)

best_multiclass <- 
  multiclass_res |> 
  select_best("roc_auc")

final_multiclass <- 
  multiclass_wflow |> 
  finalize_workflow(best_multiclass)

final_multiclass_fit <- 
  last_fit(final_multiclass, multiclass_split)

# Extract model performance
    performance <- 
      final_multiclass_fit |> 
      collect_metrics() |> 
      select(-.config, -.estimator)
    
    glmnet_auc <- 
      final_multiclass_fit |> 
      collect_metrics() |> 
      filter(.metric == "roc_auc") |> 
      pull(.estimate) |> 
      round(2)
    
    # Extract protein importance
    important_proteins <- 
      final_multiclass_fit  |> 
      extract_fit_parsnip() %>%
      tidy() |> 
      filter(term != "(Intercept)") |> 
      arrange(-abs(estimate)) |> 
      filter(abs(estimate) > 0) |> 
      select(-penalty)
    
    # Extract model predictions
    predictions_multiclass <- 
      final_multiclass_fit |> 
      collect_predictions(summarize = F) 
    
    # Confusion matrix
    cm <-
      predictions_multiclass |>
      # mutate(pred = ifelse(.pred_1_Healthy > 0.5, "Healthy", disease),
      #        Disease = ifelse(Disease == "1_Healthy", "Healthy", disease)) |>
      # mutate(Disease = factor(Disease, levels = c(disease, "Healthy")),
      #        pred = factor(pred, levels = c(disease, "Healthy"))) |> 
      conf_mat(Disease, .pred_class)
    
    cm |> 
      autoplot(type = "heatmap")
    
    # ROC curve
    roc <- 
      predictions |>
      roc_curve(truth = Disease, paste0(".pred_0_", disease)) 
    
    
    
    important_proteins |> 
      filter(class == "Cancer") |> 
      head(10)
    
    
    
# ROC curve
multiclass_predictions <- 
  final_multiclass_fit |> 
  collect_predictions() 

####

auc <- 
  multiclass_predictions |> 
  roc_auc(Disease, .pred_0_Control) 

roc_medeca <- 
  medeca_predictions |> 
  roc_curve(Disease, .pred_0_Control) |> 
  autoplot() +
  geom_text(aes(label = paste0("AUC = ", round(auc$.estimate, 3)), x = 0.75, y = 0.25), inherit.aes = F) +
  theme_hpa() +
  ggtitle("ROC curve - MEDECA")

#ggsave(savepath("ROC_MEDECA.png"), h = 5, w = 5)

# Confusion matrix
cm <- 
  final_glmnet_fit %>% 
  collect_predictions() %>%
  conf_mat(truth = Disease, estimate = .pred_class) 

cm_medeca <- 
  cm |> 
  autoplot(type = "heatmap") +
  theme_hpa(angled = T) +
  coord_fixed()

ggsave(savepath("cm_MEDECA_multiclass.png"), h = 5, w = 5)

roc_medeca + cm_medeca
ggsave(savepath("roc_cm_medeca.png"), h = 5, w = 10)


# Probabilities
medeca_predictions |> 
  ggplot(aes(.pred_Cancer, fill = Disease)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c("Cancer" = "#E16C54", "Control" = "#A0CBC7")) + 
  theme_hpa() +
  xlab("Probability cancer") +
  ggtitle("Probabilities - MEDECA") +

medeca_predictions |> 
  ggplot(aes(Disease, .pred_Cancer, color = Disease)) +
  geom_quasirandom(alpha = 0.7) +
  geom_violin(fill = NA) + 
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  scale_color_manual(values = c("Cancer" = "#E16C54", "Control" = "#A0CBC7")) + 
  theme_hpa() +
  ylab("Probability cancer") +
  ggtitle("Probabilities - MEDECA")

ggsave(savepath("prob_medeca.png"), h = 5, w = 10)

# Explore important proteins
important_proteins <- 
  final_glmnet_fit  |> 
  extract_fit_parsnip() %>%
  tidy() |> 
  filter(term != "(Intercept)") |> 
  arrange(-abs(estimate)) |> 
  filter(abs(estimate) > 0)

# Visualize protein rank
important_proteins |> 
  mutate(sign = ifelse(estimate > 0, "positive", "negative")) |> 
  ggplot(aes(abs(estimate), fct_reorder(term, abs(estimate)), fill = sign)) +
  geom_col(alpha  = 0.8) +
  theme_hpa(axis_y = F) +
  scale_fill_manual(values = c("#75B2E9", "#FE625E")) +
  xlab("Model estimate") +
  ylab("") +
  ggtitle("139 lasso features - profile") +

important_proteins |> 
  mutate(sign = ifelse(estimate > 0, "positive", "negative")) |> 
  head(30) |> 
  ggplot(aes(abs(estimate), fct_reorder(term, abs(estimate)), fill = sign)) +
  geom_col(alpha  = 0.8) +
  theme_hpa() +
  scale_fill_manual(values = c("#75B2E9", "#FE625E")) +
  xlab("Model estimate") +
  ylab("") +
  ggtitle("Top 30 lasso features")
 
ggsave(savepath("lasso_features.png"), h = 8, w = 15)

# Boxplot for top important proteins
proteins <- 
  important_proteins |> 
  head(10) |> 
  pull(term)

data |> 
  filter(Assay %in% proteins,
         Sample %in% metadata$Sample) |> 
  left_join(metadata, by = "Sample") |> 
  mutate(Assay = factor(Assay, levels = proteins),
         Cohort = factor(Cohort, levels = c("MEDECA", "ALLVOS"))) |>
  ggplot(aes(Cancer_detected, NPX, fill = Cancer_detected, color = Cancer_detected)) +
  geom_quasirandom() +
  geom_boxplot(alpha = 0.5, outlier.color = NA, color = "black") +
  facet_wrap(Cohort~Assay, scales = "free_y", nrow = 2) +
  scale_color_manual(values = c("yes" = "#E16C54", "no" = "#A0CBC7")) + 
  scale_fill_manual(values = c("yes" = "#E16C54", "no" = "#A0CBC7")) + 
  theme_hpa() +
  ggtitle("Top 10 important proteins")

ggsave(savepath("top10_important_proteins_multiclass.png"), h = 7, w = 17)
```

# Specific cancers

```{r}
meta_medeca |> 
  colnames()

selected_samples <- 
  meta_medeca |> 
  select(Sample, 
         Myelom, 
         Lymfom,
         #Colorectal, 
         Lung,
         `Ovarian or tubar`, 
         Breast, 
         #Prostate,
         `Pancreas or gall bladder or bile duct`,
         `Neuroendocrine tumors`) |> 
  pivot_longer(cols = -Sample,
               names_to = "Cancer",
               values_to = "Value") |> 
  filter(Value == 1,
         Sample != "110") |> #Lymphoma + prostate cancer
  select(-Value)

selected_samples |> 
  count(Cancer)

selected_samples

selected_assays <- c("PAEP", "PRTG", "CEACAM5",
                     "CXCL9", "CNTN5")

medeca_healthy <- 
  meta_medeca |> 
  filter(Disease_type == "Healthy")

groups <- 
  c("Lymfom",
                                            "Myelom", 
                                            "Lung",
                                            "Neuroendocrine tumors",
                                            "Pancreas or gall bladder or bile duct",
                                            "Breast",
                                            "Ovarian or tubar",
                                            "Healthy")

data |> 
  filter(Sample %in% c(selected_samples$Sample, medeca_healthy$Sample),
         Assay %in% selected_assays) |> 
  left_join(selected_samples, by = "Sample") |> 
  mutate(Cancer = ifelse(is.na(Cancer), "Healthy", Cancer),
         Cancer = factor(Cancer, levels = groups)) |> 
  ggplot(aes(Cancer, NPX, color = Cancer, fill = Cancer)) +
  geom_quasirandom(alpha = 0.8, size = 1) +
  geom_boxplot(alpha = 0.5, outlier.color = NA) +
  facet_wrap(~Assay, scales = "free_y", nrow = 1) +
  scale_color_manual(values = pal_groups) +
  scale_fill_manual(values = pal_groups) +
  theme_hpa(angled = T,
            axis_x = F)


ggsave(savepath("examples_pan_cancer.pdf"), h = 3, w = 12)
pal_groups <- c("#08585A",
                "#66C2A5",
                "#ADC74F",
                "#FDB36A",
                "#D7485A",
                "#E8A29A",  
                "#603479",
                "grey")
names(pal_groups) <- groups
```


# Comparison DE / ML

```{r}

medeca_de |> 
  left_join(important_proteins, by = c("Assay" = "term")) |> 
  filter(!is.na(estimate)) |> 
  mutate(Type = case_when(estimate > 0 & logFC > 0 ~ "Both up",
                          estimate < 0 & logFC < 0 ~ "Both down",
                          T ~ "Different sign")) |> 
  ggplot(aes(estimate, logFC, color = Type)) +
  geom_vline(xintercept = 0, lty = "dashed", color = "grey") +
  geom_hline(yintercept = 0, lty = "dashed", color = "grey") +
  geom_point() +
  geom_text_repel(aes(label = Assay)) +
  theme_hpa() +
  ggtitle("Protein importance VS fold change - MEDECA")



```

# Pan-cancer markers

```{r}

# Read in file
pancancer_markers <- read_excel("data/41467_2023_39765_MOESM7_ESM.xlsx")


# Plot 83 markers across groups?
data |> 
  filter(Assay %in% c(pancancer_markers$Protein)) |> 
  left_join(meta_combined, by = "Sample") |> 
  filter(!is.na(Cancer)) |> 
  ggplot(aes(Cancer, NPX, fill = Cancer, color = Cancer)) +
  geom_quasirandom() +
  geom_boxplot(fill = NA, outlier.color = NA, color = "black") +
  facet_wrap(~Assay, scales = "free_y") +
  theme_hpa()

dat <- 
  data |> 
  filter(Assay %in% c(pancancer_markers$Protein)) |> 
  left_join(meta_combined, by = "Sample") |> 
  filter(!is.na(Cancer)) 

ann <- 
  dat |> 
  distinct(Sample, Cohort, Cancer) |> 
  column_to_rownames("Sample")

library(pheatmap)
dat |>
  filter(Cohort == "MEDECA") |> 
  select(Sample, Assay, NPX) |> 
  pivot_wider(names_from = "Assay", values_from = "NPX") |> 
  column_to_rownames("Sample") |> 
  scale() |> 
  pheatmap(annotation_row = ann)

# PCA
pca_data_medeca <- 
  data |>
  left_join(meta_combined |> 
              select(Sample, Cohort), by = "Sample") |> 
  filter(Cohort == "MEDECA") |> 
  select(-Cohort) |> 
  filter(Sample %in% meta_combined$Sample,
         Assay %in% pancancer_markers$Protein) |> 
  pivot_wider(names_from = "Assay", values_from = "NPX")  |>  
  impute_values(ID = "Sample", wide_data = T) |> 
  column_to_rownames("Sample") |> 
  scale() |> 
  t() |> 
  do_pca()

pca_data_medeca@scores |> 
  as.data.frame() |> 
  rownames_to_column("Sample") |> 
  left_join(meta_combined, by = "Sample") |> 
  ggplot(aes(PC1, PC2, color = Cancer)) +
  geom_point(alpha = 0.7) +
  #stat_ellipse(geom = "polygon", alpha = 0.3, aes(fill = Cancer), color = NA) +
  scale_color_manual(values = pal_cancer) + 
  scale_fill_manual(values = pal_cancer) +
  ggtitle("MEDECA") +
  theme_hpa()

# Check if they are DE?

# Model



```

## ML pan-cancer markers

```{r}
# Prepare ML data
ml_data <- 
  data |> 
  left_join(meta_combined |> 
              select(Sample, Cancer, Cohort), by = "Sample") |> 
  filter(Cohort == "MEDECA") |> 
  mutate(Disease = ifelse(Cancer == "Yes", "0_Cancer", "1_Control")) |> 
  select(Sample, Disease, Assay, NPX) |> 
  filter(Assay %in% pancancer_markers$Protein) |> 
  pivot_wider(names_from = Assay,
              values_from = NPX) 

# Split data 
set.seed(213)
medeca_split <-
  ml_data |> 
  initial_split(prop = 0.7, strata = Disease)

medeca_train <- training(medeca_split)
medeca_test <- testing(medeca_split)

# Barplot
medeca_train |> 
  select(Sample, Disease) |> 
  mutate(Set = "Train") |> 
  bind_rows(medeca_test |> 
              select(Sample, Disease) |> 
              mutate(Set = "Test")) |> 
  group_by(Disease, Set) |> 
  count() |> 
  group_by(Disease) |> 
  mutate(total_n = sum(n)) |> 
  mutate(Set = factor(Set, levels = c("Test", "Train"))) |>
  ungroup() |> 
  group_by(Disease) |> 
  arrange(Disease, Set) |>
  mutate(c = cumsum(n)) |> 
  ungroup() |> 
  arrange(Disease, Set) |> 
  ggplot(aes(Disease, n, fill = (Set))) +
  geom_col() +
  geom_text(aes(label = n, y = total_n - c), vjust = -0.5, fontface = "bold") +
  scale_fill_manual(values = c("#AF91A8", "#FDC593")) +
  theme_hpa(angled = T) +
  ggtitle("Samples for machine learning - MEDECA") +
  xlab("Class")

ggsave(savepath("disease_split.png"), h = 6, w = 4)

ml_recipe <- 
  recipe(Disease ~ ., data = medeca_train) |> 
  update_role(Sample, new_role = "id") |> 
  step_normalize(all_numeric()) |> 
  step_nzv(all_numeric()) |> 
  step_corr(all_numeric()) |> 
  step_impute_knn(all_numeric()) 

# Generate resamples
set.seed(213)
medeca_rs <- vfold_cv(medeca_train, v = 10, strata = Disease)

# Define evaluation metrics for all workflows
eval_metrics <- metric_set(roc_auc, accuracy, sensitivity, specificity)

# Define control grid
set.seed(213)
ctrl <- control_grid(verbose = TRUE, 
                     allow_par = TRUE,
                     save_pred = TRUE, 
                     parallel_over = "everything") 


# Tidymodels lasso multiclassification recipe
glmnet_lasso_specs <-
  logistic_reg() |>
  set_mode("classification") |>
  set_engine("glmnet") |>
  set_args(penalty = tune(),
           mixture = 1)

# Set up lasso workflow
glmnet_wflow <-
  workflow() |> 
  add_recipe(ml_recipe) |> 
  add_model(glmnet_lasso_specs) 

# Define hyperparameter tuning grid
set.seed(213)
glmnet_grid <-
  glmnet_wflow |>
  extract_parameter_set_dials() |>
  grid_latin_hypercube(size = 30)

# Hyperparameter tuning
set.seed(213)
glmnet_res <-
  glmnet_wflow |>
  tune_grid(
    resamples = medeca_rs,
    grid = glmnet_grid,
    control = ctrl,
    metrics = eval_metrics)

#saveRDS(glmnet_res, "data/processed/ML_res/lasso_results_20240404.rds")

# Explore results and select the best performing hyperparameter combination
autoplot(glmnet_res)

best_glmnet <- 
  glmnet_res |> 
  select_best("roc_auc")

final_glmnet <- 
  glmnet_wflow |> 
  finalize_workflow(best_glmnet)

final_glmnet_fit <- 
  last_fit(final_glmnet, medeca_split)


# ROC curve
medeca_predictions <- 
  final_glmnet_fit |> 
  collect_predictions() 

auc <- 
  medeca_predictions |> 
  roc_auc(Disease, .pred_0_Control) 

roc_medeca <- 
  medeca_predictions |> 
  roc_curve(Disease, .pred_0_Control) |> 
  autoplot() +
  geom_text(aes(label = paste0("AUC = ", round(auc$.estimate, 3)), x = 0.75, y = 0.25), inherit.aes = F) +
  theme_hpa() +
  ggtitle("ROC curve - MEDECA")

#ggsave(savepath("ROC_MEDECA.png"), h = 5, w = 5)

# Confusion matrix
cm <- 
  final_glmnet_fit %>% 
  collect_predictions() %>%
  conf_mat(truth = Disease, estimate = .pred_class) 

cm_medeca <- 
  cm |> 
  autoplot(type = "heatmap") +
  theme_hpa()

#ggsave(savepath("cm_MEDECA.png"), h = 5, w = 5)

roc_medeca + cm_medeca
ggsave(savepath("roc_cm_medeca.png"), h = 5, w = 10)


# Probabilities
medeca_predictions |> 
  ggplot(aes(.pred_Cancer, fill = Disease)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c("Cancer" = "#E16C54", "Control" = "#A0CBC7")) + 
  theme_hpa() +
  xlab("Probability cancer") +
  ggtitle("Probabilities - MEDECA") +

medeca_predictions |> 
  ggplot(aes(Disease, .pred_Cancer, color = Disease)) +
  geom_quasirandom(alpha = 0.7) +
  geom_violin(fill = NA) + 
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  scale_color_manual(values = c("Cancer" = "#E16C54", "Control" = "#A0CBC7")) + 
  theme_hpa() +
  ylab("Probability cancer") +
  ggtitle("Probabilities - MEDECA")

ggsave(savepath("prob_medeca.png"), h = 5, w = 10)

# Explore important proteins
important_proteins <- 
  final_glmnet_fit  |> 
  extract_fit_parsnip() %>%
  tidy() |> 
  filter(term != "(Intercept)") |> 
  arrange(-abs(estimate)) |> 
  filter(abs(estimate) > 0)

# Visualize protein rank
important_proteins |> 
  mutate(sign = ifelse(estimate > 0, "positive", "negative")) |> 
  ggplot(aes(abs(estimate), fct_reorder(term, abs(estimate)), fill = sign)) +
  geom_col(alpha  = 0.8) +
  theme_hpa(axis_y = F) +
  scale_fill_manual(values = c("#75B2E9", "#FE625E")) +
  xlab("Model estimate") +
  ylab("") +
  ggtitle("139 lasso features - profile") +

important_proteins |> 
  mutate(sign = ifelse(estimate > 0, "positive", "negative")) |> 
  head(30) |> 
  ggplot(aes(abs(estimate), fct_reorder(term, abs(estimate)), fill = sign)) +
  geom_col(alpha  = 0.8) +
  theme_hpa() +
  scale_fill_manual(values = c("#75B2E9", "#FE625E")) +
  xlab("Model estimate") +
  ylab("") +
  ggtitle("Top 30 lasso features")
 
ggsave(savepath("lasso_features.png"), h = 8, w = 15)

# Boxplot for top important proteins
proteins <- 
  important_proteins |> 
  head(10) |> 
  pull(term)

data |> 
  filter(Assay %in% proteins,
         Sample %in% metadata$Sample) |> 
  left_join(metadata, by = "Sample") |> 
  mutate(Assay = factor(Assay, levels = proteins),
         Cohort = factor(Cohort, levels = c("MEDECA", "ALLVOS"))) |>
  ggplot(aes(Cancer_detected, NPX, fill = Cancer_detected, color = Cancer_detected)) +
  geom_quasirandom() +
  geom_boxplot(alpha = 0.5, outlier.color = NA, color = "black") +
  facet_grid(Cohort~Assay, scales = "free_y") +
  scale_color_manual(values = c("yes" = "#E16C54", "no" = "#A0CBC7")) + 
  scale_fill_manual(values = c("yes" = "#E16C54", "no" = "#A0CBC7")) + 
  theme_hpa() +
  ggtitle("Top 10 important proteins")

ggsave(savepath("top10_important_proteins.png"), h = 7, w = 17)

```


# Predict mortality

```{r}
# Prepare ML data
ml_data <- 
  data |>
  filter(Sample %in% as.character(metadata_medeca$`Patient number`)) |> 
  left_join(metadata_medeca |> 
              mutate(Sample = as.character(`Patient number`)) |> 
              select(Sample, Mortality), by = "Sample") |> 
  mutate(Disease = ifelse(Mortality == "1", "0_Yes", "1_No")) |> 
  select(Sample, Disease, Assay, NPX) |> 
  pivot_wider(names_from = Assay,
              values_from = NPX) 

# Split data 
set.seed(213)
medeca_split <-
  ml_data |> 
  initial_split(prop = 0.7, strata = Disease)

medeca_train <- training(medeca_split)
medeca_test <- testing(medeca_split)

# Barplot
medeca_train |> 
  select(Sample, Disease) |> 
  mutate(Set = "Train") |> 
  bind_rows(medeca_test |> 
              select(Sample, Disease) |> 
              mutate(Set = "Test")) |> 
  group_by(Disease, Set) |> 
  count() |> 
  group_by(Disease) |> 
  mutate(total_n = sum(n)) |> 
  mutate(Set = factor(Set, levels = c("Test", "Train"))) |>
  ungroup() |> 
  group_by(Disease) |> 
  arrange(Disease, Set) |>
  mutate(c = cumsum(n)) |> 
  ungroup() |> 
  arrange(Disease, Set) |> 
  ggplot(aes(Disease, n, fill = (Set))) +
  geom_col() +
  geom_text(aes(label = n, y = total_n - c), vjust = -0.5, fontface = "bold") +
  scale_fill_manual(values = c("#AF91A8", "#FDC593")) +
  theme_hpa(angled = T) +
  ggtitle("Samples for machine learning - MEDECA") +
  xlab("Class")

ggsave(savepath("disease_split.png"), h = 6, w = 4)

ml_recipe <- 
  recipe(Disease ~ ., data = medeca_train) |> 
  update_role(Sample, new_role = "id") |> 
  step_normalize(all_numeric()) |> 
  step_nzv(all_numeric()) |> 
  step_corr(all_numeric()) |> 
  step_impute_knn(all_numeric()) 

# Generate resamples
set.seed(213)
medeca_rs <- vfold_cv(medeca_train, v = 10, strata = Disease)

# Define evaluation metrics for all workflows
eval_metrics <- metric_set(roc_auc, accuracy, sensitivity, specificity)

# Define control grid
set.seed(213)
ctrl <- control_grid(verbose = TRUE, 
                     allow_par = TRUE,
                     save_pred = TRUE, 
                     parallel_over = "everything") 


# Tidymodels lasso multiclassification recipe
glmnet_lasso_specs <-
  logistic_reg() |>
  set_mode("classification") |>
  set_engine("glmnet") |>
  set_args(penalty = tune(),
           mixture = 1)

# Set up lasso workflow
glmnet_wflow <-
  workflow() |> 
  add_recipe(ml_recipe) |> 
  add_model(glmnet_lasso_specs) 

# Define hyperparameter tuning grid
set.seed(213)
glmnet_grid <-
  glmnet_wflow |>
  extract_parameter_set_dials() |>
  grid_latin_hypercube(size = 30)

# Hyperparameter tuning
set.seed(213)
glmnet_res <-
  glmnet_wflow |>
  tune_grid(
    resamples = medeca_rs,
    grid = glmnet_grid,
    control = ctrl,
    metrics = eval_metrics)

#saveRDS(glmnet_res, "data/processed/ML_res/lasso_results_20240404.rds")

# Explore results and select the best performing hyperparameter combination
autoplot(glmnet_res)

best_glmnet <- 
  glmnet_res |> 
  select_best("roc_auc")

final_glmnet <- 
  glmnet_wflow |> 
  finalize_workflow(best_glmnet)

final_glmnet_fit <- 
  last_fit(final_glmnet, medeca_split)


# ROC curve
medeca_predictions <- 
  final_glmnet_fit |> 
  collect_predictions() 

auc <- 
  medeca_predictions |> 
  roc_auc(Disease, .pred_0_Control) 

roc_medeca <- 
  medeca_predictions |> 
  roc_curve(Disease, .pred_0_Control) |> 
  autoplot() +
  geom_text(aes(label = paste0("AUC = ", round(auc$.estimate, 3)), x = 0.75, y = 0.25), inherit.aes = F) +
  theme_hpa() +
  ggtitle("ROC curve - MEDECA")

#ggsave(savepath("ROC_MEDECA.png"), h = 5, w = 5)

# Confusion matrix
cm <- 
  final_glmnet_fit %>% 
  collect_predictions() %>%
  conf_mat(truth = Disease, estimate = .pred_class) 

cm_medeca <- 
  cm |> 
  autoplot(type = "heatmap") +
  theme_hpa()

#ggsave(savepath("cm_MEDECA.png"), h = 5, w = 5)

roc_medeca + cm_medeca
ggsave(savepath("roc_cm_medeca.png"), h = 5, w = 10)


# Probabilities
medeca_predictions |> 
  ggplot(aes(.pred_Cancer, fill = Disease)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c("Cancer" = "#E16C54", "Control" = "#A0CBC7")) + 
  theme_hpa() +
  xlab("Probability cancer") +
  ggtitle("Probabilities - MEDECA") +

medeca_predictions |> 
  ggplot(aes(Disease, .pred_Cancer, color = Disease)) +
  geom_quasirandom(alpha = 0.7) +
  geom_violin(fill = NA) + 
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  scale_color_manual(values = c("Cancer" = "#E16C54", "Control" = "#A0CBC7")) + 
  theme_hpa() +
  ylab("Probability cancer") +
  ggtitle("Probabilities - MEDECA")

ggsave(savepath("prob_medeca.png"), h = 5, w = 10)

# Explore important proteins
important_proteins <- 
  final_glmnet_fit  |> 
  extract_fit_parsnip() %>%
  tidy() |> 
  filter(term != "(Intercept)") |> 
  arrange(-abs(estimate)) |> 
  filter(abs(estimate) > 0)

# Visualize protein rank
important_proteins |> 
  mutate(sign = ifelse(estimate > 0, "positive", "negative")) |> 
  ggplot(aes(abs(estimate), fct_reorder(term, abs(estimate)), fill = sign)) +
  geom_col(alpha  = 0.8) +
  theme_hpa(axis_y = F) +
  scale_fill_manual(values = c("#75B2E9", "#FE625E")) +
  xlab("Model estimate") +
  ylab("") +
  ggtitle("139 lasso features - profile") +

important_proteins |> 
  mutate(sign = ifelse(estimate > 0, "positive", "negative")) |> 
  head(30) |> 
  ggplot(aes(abs(estimate), fct_reorder(term, abs(estimate)), fill = sign)) +
  geom_col(alpha  = 0.8) +
  theme_hpa() +
  scale_fill_manual(values = c("#75B2E9", "#FE625E")) +
  xlab("Model estimate") +
  ylab("") +
  ggtitle("Top 30 lasso features")
 
ggsave(savepath("lasso_features.png"), h = 8, w = 15)

# Boxplot for top important proteins
proteins <- 
  important_proteins |> 
  head(10) |> 
  pull(term)

data |> 
  filter(Assay %in% proteins,
         Sample %in% metadata$Sample) |> 
  left_join(metadata, by = "Sample") |> 
  mutate(Assay = factor(Assay, levels = proteins),
         Cohort = factor(Cohort, levels = c("MEDECA", "ALLVOS"))) |>
  ggplot(aes(Cancer_detected, NPX, fill = Cancer_detected, color = Cancer_detected)) +
  geom_quasirandom() +
  geom_boxplot(alpha = 0.5, outlier.color = NA, color = "black") +
  facet_grid(Cohort~Assay, scales = "free_y") +
  scale_color_manual(values = c("yes" = "#E16C54", "no" = "#A0CBC7")) + 
  scale_fill_manual(values = c("yes" = "#E16C54", "no" = "#A0CBC7")) + 
  theme_hpa() +
  ggtitle("Top 10 important proteins")

ggsave(savepath("top10_important_proteins.png"), h = 7, w = 17)

```

