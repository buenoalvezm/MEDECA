---
title: "Cancer type analyses"
output: html_document
date: "2024-03-26"
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
# Read functions & packages
source("scripts/functions/functions_utility.R")
source("scripts/functions/functions_analyses.R")
source("scripts/functions/functions_visualization.R")
source("scripts/functions/themes_palettes.R")

# Read data
data <- import_df("data/processed/final_data/final_olink_data.csv")  
metadata <- import_df("data/processed/final_data/combined_metadata.csv")  
meta_medeca <- import_df("data/processed/final_data/medeca_metadata.csv") 
meta_allvos <- import_df("data/processed/final_data/allvos_metadata.csv")  
```

# Differential expression

```{r}
# Prepare data
limma_meta_mortality <- 
  meta_medeca |> 
  select(Sample, Mortality, Age, Sex) |> 
  mutate(Mortality = ifelse(Mortality == 1, "Yes", "No"))
  
limma_data_mortality <- 
  data |> 
  filter(Sample %in% limma_meta_mortality$Sample) |> 
  pivot_wider(names_from = Assay, 
              values_from = NPX) 

# Run differential expression analyses
mortality_de <-
  do_limma(data_wide = limma_data_mortality, 
           metadata = limma_meta_mortality,
           variable = "Mortality", 
           case = "Yes",
           correct = T) 

saveRDS(mortality_de, savepath_data("DE", "de_medeca_mortality.rds"))

volcano_medeca <- plot_volcano(mortality_de) + ggtitle("MEDECA - Mortality")
volcano_medeca
ggsave(savepath("volcano_medeca_mortality.png"), w = 5, h = 5)
```
## Check markers

### Boxplots

```{r}

```

### Heatmap

```{r}
mortality_proteins_de <- 
  mortality_de |> 
  head(50) |> 
  pull(Assay)

plot_heatmap(data = data,
             proteins = mortality_proteins_de,
             metadata = meta_medeca,
             variable = "Mortality") |> 
  as.ggplot() +
  ggtitle("Top 50 differentially expressed") +
  theme(plot.title = element_text(face = "bold",
                                  hjust = 0.5))

ggsave(savepath("heatmap_mortality_de.png"), h = 8, w = 10)
```


# Classification 

```{r}
# Prepare ML data
ml_mortality_data <- 
  data |>
  filter(Sample %in% meta_medeca$Sample) |> 
  left_join(meta_medeca |> 
              select(Sample, Mortality), by = "Sample") |> 
  mutate(Mortality = ifelse(Mortality == 1, "Yes", "No")) |> 
  pivot_wider(names_from = Assay,
              values_from = NPX) 

# Split data 
set.seed(213)
medeca_mortality_split <-
  ml_mortality_data |> 
  initial_split(prop = 0.7, strata = Mortality)

medeca_mortality_train <- training(medeca_mortality_split)
medeca_mortality_test <- testing(medeca_mortality_split)


# Run lasso pipeline
ml_medeca_mortality <- 
  do_lasso(variable = "Mortality",
           case = "Yes", 
           split_train = medeca_mortality_train, 
           split_test = medeca_mortality_test) 

saveRDS(ml_medeca_mortality, savepath_data("ML", "ml_medeca_mortality.rds"))
```

## Check markers

### Boxplots

```{r}
ml_medeca_mortality$important_proteins

plot_beeswarm(data = data |> 
                filter(Sample %in% meta_medeca$Sample),
              metadata = meta_medeca |> 
                mutate(Mortality = ifelse(Mortality == 1, "Yes", "No")),
              proteins = "ULBP2",
              variable = "Mortality",
              palette = pal_binary)


top_10 <- 
  ml_medeca_mortality$important_proteins |> 
  head(10) |> 
  pull(term)

plot_beeswarm(data = data |> 
                filter(Sample %in% meta_medeca$Sample),
              metadata = meta_medeca |> 
                mutate(Mortality = ifelse(Mortality == 1, "Yes", "No")),
              proteins = top_10,
              variable = "Mortality",
              palette = pal_binary)

ggsave(savepath("top_proteins_mortality.png"), h = 3, w = 12)
```
### Heatmap

```{r}
mortality_proteins <- 
  ml_medeca_mortality$important_proteins |> 
  head(10) |> 
  pull(term)

plot_heatmap(data = data,
             proteins = mortality_proteins,
             metadata = meta_medeca,
             variable = "Mortality") |> 
  as.ggplot()

ggsave(savepath("heatmap_mortality_ml.png"), h = 3, w = 10)
```

## Performance

```{r}
ml_medeca_mortality$performance

plot_roc_curve(roc = ml_medeca_mortality$roc_curve,
               auc = ml_medeca_mortality$performance$.estimate)
ml_medeca_mortality$confusion_matrix |> 
  autoplot(type = "heatmap") +
  theme_hpa()
```


